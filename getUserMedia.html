
<!doctype html>
<head>
    <title>get user media</title>

</head>
<body>
    <video autoplay id="vid"></video>
<canvas id="canvas" width="640" height="480" style="border:1px solid #d3d3d3;"></canvas><br>
<button onclick="frameGrabToggle()" id="frameGrabButton">Stop Grabbing Frames</button>
<input type="number" id="setPixelSize" name="pixelSize" min="5" max="200" value="50">
<div id="imageHolder">
</div>

<script type="text/javascript">

    var video = document.querySelector("#vid");
    var canvas = document.querySelector('#canvas');
    var ctx = canvas.getContext('2d');
    var localMediaStream = null;
    //
    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    //
    var imgGrabInt = 1; // iterate frames to limit how often images are drawn into canvas
    var imgGrab = true;
    //
    var onCameraFail = function (e) {
        console.log('Camera did not work.', e);
    };

    function snapshot() {
        if (localMediaStream) {
            ctx.drawImage(video, 0, 0);
        }
    }

    function transformGrab() {
        //
        console.log("transform grab");
        //
        imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        //
        var input = document.querySelector('#setPixelSize');
        var p = parseFloat(input.value);
        console.log("p = " + p);
        pixellate(p);
    }

    function frameGrabToggle() {
        console.log("toggle");
        console.log(imgGrab);
        //
        imgGrab = !imgGrab;
        //
        console.log(imgGrab);
        if(imgGrab) {
            document.querySelector('#frameGrabButton').innerHTML = "Stop Grabbing Frames";
        } else {
            document.querySelector('#frameGrabButton').innerHTML = "Start Grabbing Frames";
        }
    }

    function pixellate(size) {
        var x, y;
        for(x = 0; x < canvas.width; x += size) {
            for(y = 0; y < canvas.height; y += size) {
                //console.log("tick", y * canvas.width + x)
                ctx.fillStyle = getPixel(imageData, x, y);
                ctx.fillRect(x, y, size, size);
            }
        }
    }
     
    function getPixel(imageData, x, y) {
        var r, g, b, a, offset = x * 4 + y * 4 * imageData.width;
        r = imageData.data[offset];
        g = imageData.data[offset + 1];
        b = imageData.data[offset + 2];
        a = imageData.data[offset + 3];
        return "rgba(" + r + "," + g + "," + b + "," + a + ")";
    }

    function saveCanvasImage() {
        //
        var dataURL = canvas.toDataURL();
        //document.querySelector('#canvasImage').src = dataURL;
        document.querySelector('#imageHolder').innerHTML += "<img src ="+dataURL+" />"
    }

   function drawVideoAtCanvas(obj, context) {
        window.setInterval(function() { 
            // draw video image to canvas
            context.drawImage(obj, 0, 0);
            // update pixel data
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            // pixellate
            var input = document.querySelector('#setPixelSize');
            var p = parseFloat(input.value);
            var pCheck = false;
            if(p<5) {
                p=5;
                pCheck = true;
            }
            pixellate(p);
            //
            if(imgGrabInt >= 60 && imgGrab === true) {
                console.log("grab");
                if(pCheck === true) {
                    document.querySelector('#setPixelSize').value = 5;
                }
                var dataURL = canvas.toDataURL();
                document.querySelector('#imageHolder').innerHTML += "<img src ="+dataURL+" style='max-width:100px; max-height:100px;' />";
                //
                imgGrabInt = 0;
            }
            imgGrabInt++;
        }, 60);
        //
        
    }


    video.addEventListener('play', function() { drawVideoAtCanvas(video, ctx) }, false);


    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.URL = window.URL || window.webkitURL;
    navigator.getUserMedia({video:true}, function (stream) {
        video.src = window.URL.createObjectURL(stream);
        localMediaStream = stream;
    }, onCameraFail);

</script>
</body>

</html>